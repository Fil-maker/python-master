{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏ -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞—â–µ–Ω–∏–∏</h5>
                    <span class="badge bg-dark">{{ ticket.ticket_id }}</span>
                </div>
                <div class="card-body">
                    <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å -->
                    <div class="mb-4">
                        <h6>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</h6>
                        <div class="d-flex align-items-center">
                            {% if ticket.user_photo %}
                            <img src="{{ ticket.user_photo }}" class="rounded-circle me-3"
                                 width="50" height="50" alt="{{ ticket.user_name }}">
                            {% endif %}
                            <div>
                                <strong>{{ ticket.user_name }}</strong><br>
                                <small class="text-muted">ID: {{ ticket.user_id }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- –§–æ—Ä–º—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                    <form method="post" class="mb-3">
                        {% csrf_token %}
                        <!-- –°—Ç–∞—Ç—É—Å -->
                        <div class="mb-3">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å:</label>
                            <select name="status" class="form-select">
                                {% for code, name in ticket.STATUS_CHOICES %}
                                <option value="{{ code }}" {% if ticket.status == code %}selected{% endif %}>
                                    {{ name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
                        <div class="mb-3">
                            <label class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:</label>
                            <select name="priority" class="form-select">
                                {% for code, name in ticket.PRIORITY_CHOICES %}
                                <option value="{{ code }}" {% if ticket.priority == code %}selected{% endif %}>
                                    {{ name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- –¢–µ–≥–∏ -->
                        <div class="mb-3">
                            <label class="form-label">–¢–µ–≥–∏:</label>
                            <select name="tags" class="form-select" multiple>
                                {% for tag in all_tags %}
                                <option value="{{ tag.id }}" {% if tag in ticket.tags.all %}selected{% endif %}>
                                    {{ tag.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ–≥–æ–≤</small>
                        </div>

                        <!-- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π -->
                        <div class="mb-3">
                            <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</label>
                            <div class="d-flex align-items-center">
                                {% if ticket.admin %}
                                <span class="me-2">{{ ticket.admin.username }}</span>
                                {% else %}
                                <span class="me-2 text-muted">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                {% endif %}
                                <button type="submit" name="assign_to_me" class="btn btn-sm btn-outline-primary">
                                    –ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ –º–µ–Ω—è
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </form>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <hr>
                    <div class="small text-muted">
                        <div>–°–æ–∑–¥–∞–Ω–æ: {{ ticket.created_at|date:"d.m.Y H:i" }}</div>
                        <div>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ ticket.updated_at|date:"d.m.Y H:i" }}</div>
                        {% if ticket.closed_at %}
                        <div>–ó–∞–∫—Ä—ã—Ç–æ: {{ ticket.closed_at|date:"d.m.Y H:i" }}</div>
                        {% endif %}
                        <div>–°–æ–æ–±—â–µ–Ω–∏–π: {{ ticket.messages.count }}</div>
                        <div>–ì—Ä—É–ø–ø–∞: {{ ticket.vk_group.name }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>–ü–µ—Ä–µ–ø–∏—Å–∫–∞</h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="chat-container">
                    {% for message in messages %}
                    <div class="mb-3 {% if message.is_admin %}text-end{% endif %}">
                        <div class="d-flex {% if message.is_admin %}justify-content-end{% endif %}">
                            {% if not message.is_admin %}
                            <div class="flex-shrink-0 me-2">
                                {% if ticket.user_photo %}
                                <img src="{{ ticket.user_photo }}" class="rounded-circle"
                                     width="30" height="30" alt="{{ ticket.user_name }}">
                                {% endif %}
                            </div>
                            {% endif %}

                            <div>
                                <div class="alert {% if message.is_admin %}alert-primary{% else %}alert-secondary{% endif %} mb-1">
                                    {{ message.text|linebreaks }}

                                    {% if message.attachments %}
                                    <div class="mt-2">
                                        {% for attach in message.attachments %}
                                        {% if attach.type == 'photo' %}
                                        <img src="{{ attach.photo.sizes.2.url }}" class="img-thumbnail" style="max-height: 100px;">
                                        {% elif attach.type == 'doc' %}
                                        <div class="alert alert-light p-2 small">
                                            üìÑ {{ attach.doc.title }} ({{ attach.doc.ext|upper }})
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>

                                <small class="text-muted">
                                    {% if message.is_admin %}
                                    {{ message.admin_author.username }} ‚Ä¢
                                    {% endif %}
                                    {{ message.created_at|date:"d.m.Y H:i" }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-4">
                        –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ -->
            <div class="card">
                <div class="card-header">
                    <h5>–û—Ç–≤–µ—Ç–∏—Ç—å</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <textarea name="response" class="form-control" rows="4"
                                      placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é..." required></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —á–∞—Ç–∞ –≤–Ω–∏–∑
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-container');
    if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
});
</script>
{% endblock %}